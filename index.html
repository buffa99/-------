<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ユニット掲示板システム</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes bounce-small {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    .badge-bounce { animation: bounce-small 1s infinite; }
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    body { font-size: 18px; background-color: #f1f5f9; }
    /* スクロールバーの調整 */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

// --- アイコンコンポーネント ---
const Icon = ({ type, size = 24, className = "" }) => {
  const icons = {
    user: <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>,
    check: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
    alert: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
    clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
    users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
    layout: <><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></>,
    settings: <><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>,
    edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
    trash: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>,
    chevronDown: <polyline points="6 9 12 15 18 9"/>,
    chevronUp: <polyline points="18 15 12 9 6 15"/>,
    messageSquare: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>,
    send: <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
    list: <><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>,
    plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
    x: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
    arrowLeft: <><line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" /></>,
  };
  return (
    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" 
         fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
         className={className}>
      {icons[type]}
    </svg>
  );
};

// --- 管理者バッジコンポーネント ---
const AdminBadge = ({ user }) => {
  if (!user) return null;
  if (user.role === 'admin') {
    return (
      <span>
        <span className="text-red-600 font-bold text-lg mr-2">管理者</span>
        <span>{user.name}</span>
      </span>
    );
  }
  return <span>{user.name}</span>;
};

// --- モックデータ（初期値） ---
const INITIAL_USERS = [
  { id: 'u1', name: '佐藤', role: 'admin', image: '佐' },
  { id: 'u2', name: '鈴木 介護士', role: 'staff', image: '鈴' },
  { id: 'u3', name: '高橋 介護士', role: 'staff', image: '高' },
  { id: 'u4', name: '田中 看護師', role: 'nurse', image: '田' },
  { id: 'u5', name: '伊藤 ヘルパー', role: 'helper', image: '伊' },
  { id: 'u6', name: '新人 渡辺', role: 'staff', image: '渡' },
];

const INITIAL_MESSAGES = [
  {
    id: 'm1',
    title: '【重要】感染症対策の徹底について',
    content: 'インフルエンザ流行の兆しがあります。手洗い・うがい、マスク着用を徹底してください。',
    priority: 'high',
    timestamp: new Date(Date.now() - 1000 * 60 * 60 * 2).toISOString(),
    author: '施設長',
  },
  {
    id: 'm2',
    title: '205号室 田中様の食事変更',
    content: '本日の夕食より、刻み食からミキサー食へ変更となります。',
    priority: 'normal',
    timestamp: new Date(Date.now() - 1000 * 60 * 60 * 5).toISOString(),
    author: '栄養課',
  },
];

const ROLE_NAMES = {
  admin: '管理者',
  leader: 'リーダー',
  nurse: '看護師',
  staff: '介護士',
  helper: 'ヘルパー',
  other: 'その他'
};

// --- メインアプリ ---
function App() {
  // ユニット名（localStorage）
  const [unitName, setUnitName] = useState(() => localStorage.getItem('unit_bbs_unit_name') || '');

  // 職員データ（localStorage）
  const [users, setUsers] = useState(() => {
    const saved = localStorage.getItem('unit_bbs_users');
    return saved ? JSON.parse(saved) : INITIAL_USERS;
  });

  // 連絡事項データ
  const [messages, setMessages] = useState(() => {
    const saved = localStorage.getItem('unit_bbs_messages');
    return saved ? JSON.parse(saved) : INITIAL_MESSAGES;
  });
  
  // 既読ログ
  const [readLogs, setReadLogs] = useState(() => {
    const saved = localStorage.getItem('unit_bbs_readlogs');
    return saved ? JSON.parse(saved) : [];
  });

  // 掲示板（タイムライン）データ
  const [posts, setPosts] = useState(() => {
    const saved = localStorage.getItem('unit_bbs_posts');
    return saved ? JSON.parse(saved) : [];
  });

  // 掲示板既読ログ
  const [postReadLogs, setPostReadLogs] = useState(() => {
    const saved = localStorage.getItem('unit_bbs_post_readlogs');
    return saved ? JSON.parse(saved) : [];
  });

  const [currentUser, setCurrentUser] = useState(null);
  const [viewMode, setViewMode] = useState('login'); // login, dashboard, admin, setup

  // 永続化
  useEffect(() => { localStorage.setItem('unit_bbs_unit_name', unitName); }, [unitName]);
  useEffect(() => { localStorage.setItem('unit_bbs_users', JSON.stringify(users)); }, [users]);
  useEffect(() => { localStorage.setItem('unit_bbs_messages', JSON.stringify(messages)); }, [messages]);
  useEffect(() => { localStorage.setItem('unit_bbs_readlogs', JSON.stringify(readLogs)); }, [readLogs]);
  useEffect(() => { localStorage.setItem('unit_bbs_posts', JSON.stringify(posts)); }, [posts]);
  useEffect(() => { localStorage.setItem('unit_bbs_post_readlogs', JSON.stringify(postReadLogs)); }, [postReadLogs]);

  // 初期化チェック
  useEffect(() => {
    if (!unitName && viewMode !== 'setup') {
      setViewMode('setup');
    }
  }, [unitName]);

  const handleLogin = (user) => {
    setCurrentUser(user);
    markAsReadAutomatically(user.id);
    setViewMode('dashboard');
  };

  const handleLogout = () => {
    setCurrentUser(null);
    setViewMode('login');
  };

  // 自動既読（通常メッセージのみ）
  const markAsReadAutomatically = (userId) => {
    const now = new Date().toISOString();
    const newLogs = [];
    messages.forEach(msg => {
      if (msg.priority === 'high') return;
      const alreadyRead = readLogs.some(log => log.messageId === msg.id && log.userId === userId);
      if (!alreadyRead) {
        newLogs.push({ messageId: msg.id, userId: userId, timestamp: now });
      }
    });
    if (newLogs.length > 0) setReadLogs(prev => [...prev, ...newLogs]);
  };

  // 手動既読（掲示板投稿）
  const handlePostManualRead = (postId) => {
    if (!currentUser) return;
    const now = new Date().toISOString();
    const alreadyRead = postReadLogs.some(log => log.postId === postId && log.userId === currentUser.id);
    if (!alreadyRead) {
      setPostReadLogs(prev => [...prev, { postId: postId, userId: currentUser.id, timestamp: now }]);
    }
  };

  // 手動既読（重要メッセージ）
  const handleManualRead = (msgId) => {
    if (!currentUser) return;
    const now = new Date().toISOString();
    const alreadyRead = readLogs.some(log => log.messageId === msgId && log.userId === currentUser.id);
    if (!alreadyRead) {
      setReadLogs(prev => [...prev, { messageId: msgId, userId: currentUser.id, timestamp: now }]);
    }
  };

  // メッセージ管理
  const handleSaveMessage = (messageData) => {
    if (messageData.id) {
      setMessages(messages.map(m => m.id === messageData.id ? { ...m, ...messageData } : m));
    } else {
      const msg = { ...messageData, id: 'm' + Date.now(), timestamp: new Date().toISOString() };
      setMessages([msg, ...messages]);
    }
  };
  const handleDeleteMessage = (id) => { setMessages(messages.filter(m => m.id !== id)); };

  // 掲示板投稿
  const handleAddPost = (content) => {
    const newPost = {
      id: 'p' + Date.now(),
      content,
      author: currentUser.name,
      authorId: currentUser.id,
      timestamp: new Date().toISOString(),
    };
    setPosts([newPost, ...posts]);
    // 投稿者は自動既読
    const now = new Date().toISOString();
    setPostReadLogs(prev => [...prev, { postId: newPost.id, userId: currentUser.id, timestamp: now }]);
  };
  const handleDeletePost = (postId) => {
    setPosts(posts.filter(p => p.id !== postId));
    setPostReadLogs(prev => prev.filter(log => log.postId !== postId));
  };

  // 職員管理
  const handleAddUser = (userData) => {
    const newUser = { ...userData, id: 'u' + Date.now() };
    setUsers([...users, newUser]);
  };
  const handleUpdateUser = (userData) => {
    setUsers(users.map(u => u.id === userData.id ? { ...u, ...userData } : u));
  };
  const handleDeleteUser = (userId) => {
    setUsers(users.filter(u => u.id !== userId));
  };

  // ---------- 初回セットアップ画面 ----------
  if (viewMode === 'setup') {
    return (
      <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full text-center">
          <div className="mb-6 flex justify-center text-blue-600">
            <Icon type="settings" size={64} />
          </div>
          <h1 className="text-3xl font-bold text-slate-800 mb-4">初期設定</h1>
          <p className="text-slate-500 mb-6">
            このPCで使用するユニット名を入力してください。<br/>
            （例：1F-東ユニット）
          </p>
          <form onSubmit={(e) => {
            e.preventDefault();
            const val = e.target.unit.value.trim();
            if(val) {
              setUnitName(val);
              setViewMode('login');
            }
          }}>
            <input name="unit" type="text" className="w-full p-4 border-2 border-slate-300 rounded-xl text-xl mb-6 focus:border-blue-500 outline-none" placeholder="ユニット名を入力" autoFocus />
            <button type="submit" className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl text-xl hover:bg-blue-700 transition-colors">
              設定して開始
            </button>
          </form>
        </div>
      </div>
    );
  }

  // ---------- ログイン画面 ----------
  const LoginScreen = () => {
    const [pendingUser, setPendingUser] = useState(null);

    const getUnreadCount = (userId) => {
      return messages.filter(msg => 
        !readLogs.some(log => log.messageId === msg.id && log.userId === userId)
      ).length;
    };

    return (
      <div className="min-h-screen bg-slate-50 p-4">
        <div className="bg-white/80 backdrop-blur rounded-xl p-4 mb-4 shadow-sm text-center border border-slate-200 max-w-3xl mx-auto">
          <h2 className="text-lg text-slate-500 font-bold">社会福祉法人 相模原敬寿園</h2>
          <h1 className="text-3xl font-bold text-blue-700 mt-1">{unitName}</h1>
        </div>

        <header className="mb-8 text-center pt-4">
          <h1 className="text-4xl font-bold text-slate-700 mb-2">おはようございます</h1>
          <p className="text-xl text-slate-500">名前を選んで開始してください</p>
        </header>

        <div className="max-w-5xl mx-auto grid grid-cols-2 md:grid-cols-3 gap-6">
          {users.map(user => {
            const unreadCount = getUnreadCount(user.id);
            return (
              <button key={user.id} onClick={() => setPendingUser(user)}
                className="relative bg-white p-6 rounded-2xl shadow-sm border-2 border-slate-200 hover:border-blue-400 hover:shadow-md transition-all active:scale-95 flex flex-col items-center justify-center h-48">
                {unreadCount > 0 && (
                  <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xl font-bold w-12 h-12 rounded-full flex items-center justify-center badge-bounce shadow-lg">
                    {unreadCount}
                  </span>
                )}
                <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center text-3xl font-bold text-blue-600 mb-4">
                  {user.image}
                </div>
                <span className="text-2xl font-bold text-slate-700"><AdminBadge user={user} /></span>
              </button>
            );
          })}
        </div>
        <div className="mt-12 text-center">
          <button onClick={() => setViewMode('admin')} className="text-slate-400 underline p-4 hover:text-slate-600 text-lg">
            管理者モードへ
          </button>
        </div>

        {pendingUser && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 animate-fade-in">
            <div className="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
              <h3 className="text-2xl font-bold text-slate-800 mb-6 text-center">本人確認</h3>
              <div className="flex flex-col items-center mb-8">
                <div className="w-28 h-28 bg-blue-100 rounded-full flex items-center justify-center text-5xl font-bold text-blue-600 mb-4">
                  {pendingUser.image}
                </div>
                <p className="text-2xl text-slate-700 text-center leading-relaxed">
                  あなたは<br/>
                  <span className="font-bold text-3xl"><AdminBadge user={pendingUser} /></span> さん<br/>
                  ですか？
                </p>
              </div>
              <div className="flex gap-4">
                <button onClick={() => setPendingUser(null)}
                  className="flex-1 py-5 rounded-xl border-2 border-slate-300 text-slate-600 font-bold text-xl hover:bg-slate-50 transition-colors">
                  いいえ
                </button>
                <button onClick={() => { handleLogin(pendingUser); setPendingUser(null); }}
                  className="flex-1 py-5 rounded-xl bg-blue-600 text-white font-bold text-xl hover:bg-blue-700 shadow-lg transition-colors">
                  はい
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // ---------- ダッシュボード ----------
  const DashboardScreen = () => {
    const [activeTab, setActiveTab] = useState('check'); // check or board

    const getUnreadPostCount = () => {
      return posts.filter(post => 
        !postReadLogs.some(log => log.postId === post.id && log.userId === currentUser.id)
      ).length;
    };

    return (
      <div className="min-h-screen bg-slate-100 flex flex-col">
        {/* ヘッダー */}
        <div className="bg-white shadow-sm p-4 sticky top-0 z-20 flex justify-between items-center border-b border-slate-200">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
              {currentUser.image}
            </div>
            <div>
              <p className="text-sm text-slate-500">{unitName}</p>
              <p className="text-2xl font-bold text-slate-800"><AdminBadge user={currentUser} /> さん</p>
            </div>
          </div>
          <div className="flex gap-2">
            {currentUser.role === 'admin' && (
              <button onClick={() => setViewMode('admin')} className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                <Icon type="settings" /> 管理者コンソール
              </button>
            )}
            <button onClick={handleLogout} className="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2">
              <Icon type="arrowLeft" /> トップに戻る
            </button>
          </div>
        </div>

        {/* タブ切り替え */}
        <div className="bg-white border-b border-slate-200 sticky top-[81px] z-10">
          <div className="max-w-4xl mx-auto flex">
            <button onClick={() => setActiveTab('check')}
              className={`flex-1 py-4 text-xl font-bold flex items-center justify-center gap-2 border-b-4 transition-colors ${activeTab === 'check' ? 'border-blue-600 text-blue-600 bg-blue-50' : 'border-transparent text-slate-400 hover:bg-slate-50'}`}>
              <Icon type="list" /> 連絡チェック
            </button>
            <button onClick={() => setActiveTab('board')}
              className={`relative flex-1 py-4 text-xl font-bold flex items-center justify-center gap-2 border-b-4 transition-colors ${activeTab === 'board' ? 'border-green-600 text-green-600 bg-green-50' : 'border-transparent text-slate-400 hover:bg-slate-50'}`}>
              <Icon type="messageSquare" /> 掲示板
              {getUnreadPostCount() > 0 && (
                <span className="absolute top-2 right-1/4 bg-red-500 text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center badge-bounce shadow-md">
                  {getUnreadPostCount()}
                </span>
              )}
            </button>
          </div>
        </div>

        {/* コンテンツエリア */}
        <div className="flex-1 p-4 max-w-4xl mx-auto w-full pb-32">
          {activeTab === 'check' ? <ContactCheckTab /> : <BulletinBoardTab />}
        </div>
      </div>
    );
  };

  // --- タブ1: 連絡チェック ---
  const ContactCheckTab = () => {
    const [showOldMessages, setShowOldMessages] = useState(false);
    const now = new Date();
    const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;
    
    const recentMessages = [];
    const oldMessages = [];

    messages.forEach(msg => {
      if ((now - new Date(msg.timestamp)) > SEVEN_DAYS_MS) {
        oldMessages.push(msg);
      } else {
        recentMessages.push(msg);
      }
    });

    const importantMessages = recentMessages.filter(m => m.priority === 'high');
    const normalMessages = recentMessages.filter(m => m.priority !== 'high');

    return (
      <div className="space-y-8 animate-fade-in pt-4">
        {importantMessages.length > 0 && (
          <div className="space-y-4">
            <h2 className="text-red-600 font-bold flex items-center gap-2 text-2xl">
              <Icon type="alert" size={28} /> 必ず確認してください（重要）
            </h2>
            {importantMessages.map(msg => (
              <MessageCard key={msg.id} msg={msg} isHighPriority={true} 
                isRead={readLogs.some(l => l.messageId === msg.id && l.userId === currentUser.id)}
                onConfirm={() => handleManualRead(msg.id)} />
            ))}
          </div>
        )}
        
        <div className="space-y-4">
          <h2 className="text-slate-600 font-bold flex items-center gap-2 text-2xl">
            <Icon type="layout" size={28} /> 通常の連絡事項
          </h2>
          {normalMessages.length === 0 ? (
            <p className="text-slate-400 text-center py-8 text-xl bg-white rounded-xl border-2 border-dashed border-slate-200">
              現在、新しい連絡事項はありません
            </p>
          ) : (
            normalMessages.map(msg => <MessageCard key={msg.id} msg={msg} />)
          )}
        </div>

        {oldMessages.length > 0 && (
          <div className="border-t-2 border-slate-200 pt-6">
            <button onClick={() => setShowOldMessages(!showOldMessages)}
              className="flex items-center gap-2 text-slate-500 font-bold text-xl hover:text-slate-700 transition-colors w-full justify-center">
              {showOldMessages ? <Icon type="chevronUp" /> : <Icon type="chevronDown" />}
              過去の連絡（{oldMessages.length}件）
            </button>
            {showOldMessages && (
              <div className="mt-4 space-y-4 animate-fade-in">
                {oldMessages.map(msg => <MessageCard key={msg.id} msg={msg} isOld={true} />)}
              </div>
            )}
          </div>
        )}
      </div>
    );
  };

  // --- タブ2: 掲示板（タイムライン） ---
  const BulletinBoardTab = () => {
    const [newPostContent, setNewPostContent] = useState('');

    const submitPost = (e) => {
      e.preventDefault();
      if (!newPostContent.trim()) return;
      handleAddPost(newPostContent);
      setNewPostContent('');
    };

    const formatDate = (ts) => {
      const d = new Date(ts);
      return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    };

    return (
      <div className="animate-fade-in pt-4">
        {/* 投稿フォーム */}
        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-8">
          <h3 className="text-lg font-bold text-slate-700 mb-2 flex items-center gap-2">
            <Icon type="edit" size={20} /> 今何がありましたか？
          </h3>
          <form onSubmit={submitPost}>
            <textarea
              value={newPostContent}
              onChange={(e) => setNewPostContent(e.target.value)}
              className="w-full p-4 rounded-lg bg-slate-50 border border-slate-300 focus:border-green-500 outline-none text-lg min-h-[100px] resize-y"
              placeholder="申し送り事項や気づいたことを共有しましょう..."
            />
            <div className="flex justify-end mt-2">
              <button type="submit" disabled={!newPostContent.trim()}
                className="bg-green-600 hover:bg-green-700 disabled:bg-slate-300 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2 transition-colors">
                <Icon type="send" size={20} /> 投稿する
              </button>
            </div>
          </form>
        </div>

        {/* タイムライン */}
        <div className="space-y-4">
          {posts.length === 0 ? (
            <p className="text-slate-400 text-center py-12 text-xl">まだ投稿はありません。<br/>最初の投稿をしてみましょう！</p>
          ) : (
            posts.map(post => (
              <div key={post.id} className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 relative group">
                <div className="flex justify-between items-start mb-2">
                  <div className="flex items-center gap-2">
                    <div className="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center text-green-700 font-bold text-sm">
                      {post.author.charAt(0)}
                    </div>
                    <span className="font-bold text-slate-800">{post.author}</span>
                    <span className="text-slate-400 text-sm">{formatDate(post.timestamp)}</span>
                  </div>
                  {post.authorId === currentUser.id && (
                    <button onClick={() => { if(confirm('この投稿を削除しますか？')) handleDeletePost(post.id); }}
                      className="text-slate-300 hover:text-red-500 p-1 rounded transition-colors">
                      <Icon type="trash" size={18} />
                    </button>
                  )}
                </div>
                <p className="text-lg text-slate-700 whitespace-pre-wrap leading-relaxed pl-10">
                  {post.content}
                </p>
                
                {/* 確認ボタンエリア */}
                {post.authorId !== currentUser.id && (
                  <div className="pl-10 my-3">
                    {postReadLogs.some(l => l.postId === post.id && l.userId === currentUser.id) ? (
                      <div className="inline-flex items-center gap-2 bg-green-100 text-green-800 font-bold py-2 px-4 rounded-lg border border-green-200">
                        <Icon type="check" size={20} /> 確認済み
                      </div>
                    ) : (
                      <button onClick={() => handlePostManualRead(post.id)}
                        className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 transition-colors">
                        <Icon type="check" size={20} /> 確認しました
                      </button>
                    )}
                  </div>
                )}

                <div className="pl-10">
                  <ReadStatusList users={users} readUserIds={postReadLogs.filter(l => l.postId === post.id).map(l => l.userId)} />
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    );
  };

  // ---------- メッセージカード ----------
  const MessageCard = ({ msg, isHighPriority, isRead, onConfirm, isOld }) => {
    const formatDate = (ts) => {
      const d = new Date(ts);
      return (d.getMonth()+1) + '/' + d.getDate() + ' ' + 
             String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
    };

    return (
      <div className={"bg-white rounded-xl p-6 shadow-sm border-l-8 " + (isHighPriority ? 'border-red-500 bg-red-50/50' : isOld ? 'border-slate-300 bg-slate-50' : 'border-blue-400')}>
        <div className="flex justify-between items-start mb-3">
          <div className="flex-1">
            <h3 className={"text-2xl font-bold leading-tight " + (isOld ? 'text-slate-500' : 'text-slate-800')}>{msg.title}</h3>
          </div>
          {isHighPriority && (
            <span className="bg-red-100 text-red-600 px-3 py-1 rounded text-sm font-bold whitespace-nowrap ml-3">重要</span>
          )}
        </div>
        <p className={"text-xl whitespace-pre-wrap leading-relaxed mb-4 " + (isOld ? 'text-slate-500' : 'text-slate-700')}>{msg.content}</p>
        
        {isHighPriority && !isOld && (
          <div className="my-6">
            {!isRead ? (
              <button onClick={onConfirm}
                className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-5 rounded-xl shadow-md flex items-center justify-center gap-2 animate-pulse transition-colors text-xl">
                <Icon type="check" size={28} /> 内容を確認しました
              </button>
            ) : (
              <div className="w-full bg-red-100 text-red-800 font-bold py-4 rounded-xl flex items-center justify-center gap-2 border border-red-200 text-xl">
                <Icon type="check" size={24} /> 確認済み
              </div>
            )}
          </div>
        )}

        <ReadStatusList users={users} readUserIds={readLogs.filter(l => l.messageId === msg.id).map(l => l.userId)} />

        <div className="flex justify-between items-center text-base text-slate-400 border-t pt-4 border-slate-100">
          <span className="flex items-center gap-2"><Icon type="user" size={18} /> {msg.author}</span>
          <span className="flex items-center gap-2"><Icon type="clock" size={18} /> {formatDate(msg.timestamp)}</span>
        </div>
      </div>
    );
  };

  // ---------- 既読ステータスリスト ----------
  const ReadStatusList = ({ users, readUserIds }) => {
    return (
      <div className="mt-2 pt-2 border-t border-slate-100">
        <div className="flex flex-wrap gap-x-4 gap-y-2">
          {users.map(user => {
            const isRead = readUserIds.includes(user.id);
            return (
              <div key={user.id} className={`text-sm ${isRead ? 'text-slate-700' : 'text-slate-400'}`}>
                <AdminBadge user={user} />
                <span className={`ml-1 font-bold ${isRead ? 'text-green-600' : 'text-slate-300'}`}>{isRead ? ' ✔' : ' 未'}</span>
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  // ---------- 管理者画面 ----------
  const AdminScreen = () => {
    const [tab, setTab] = useState('status'); // status, create, users
    const [editingId, setEditingId] = useState(null);
    const [title, setTitle] = useState('');
    const [content, setContent] = useState('');
    const [priority, setPriority] = useState('normal');
    const [editUnitName, setEditUnitName] = useState(unitName);

    // 職員管理用state
    const [editingUser, setEditingUser] = useState(null);
    const [userName, setUserName] = useState('');

    const startEdit = (msg) => {
      setEditingId(msg.id);
      setTitle(msg.title);
      setContent(msg.content);
      setPriority(msg.priority);
      setTab('create');
    };

    const resetForm = () => {
      setEditingId(null); setTitle(''); setContent(''); setPriority('normal');
    };

    const getMessageReadStatus = (msgId) => {
      const readUserIds = readLogs.filter(log => log.messageId === msgId).map(log => log.userId);
      const unreadUsers = users.filter(u => !readUserIds.includes(u.id));
      return { readCount: readUserIds.length, unreadUsers };
    };

    const handleSubmit = () => {
      if (!title || !content) return;
      handleSaveMessage({ id: editingId, title, content, priority, author: '管理者' });
      resetForm(); setTab('status');
      alert(editingId ? '連絡事項を更新しました' : '連絡事項を投稿しました');
    };

    const handleDelete = (id) => {
      if(confirm('本当にこの連絡事項を削除しますか？')) handleDeleteMessage(id);
    };

    const handleUnitNameChange = () => {
      if(editUnitName.trim()) {
        setUnitName(editUnitName);
        alert('ユニット名を変更しました');
      }
    };

    const clearData = () => {
      if(confirm('全てのデータを初期化しますか？\n（メッセージ、既読ログ、掲示板、ユニット名設定、職員データが削除されます）')) {
        localStorage.clear();
        location.reload();
      }
    };

    // 職員管理ロジック
    const startEditUser = (user) => {
      setEditingUser(user);
      setUserName(user.name);
    };

    const resetUserForm = () => {
      setEditingUser(null);
      setUserName('');
    };

    const handleUserSubmit = (e) => {
      e.preventDefault();
      if (!userName) return;
      
      const userData = {
        id: editingUser ? editingUser.id : undefined,
        name: userName,
        role: editingUser ? editingUser.role : 'staff',
        image: userName.charAt(0)
      };

      if (editingUser) {
        handleUpdateUser(userData);
        alert('職員情報を更新しました');
      } else {
        handleAddUser(userData);
        alert('職員を追加しました');
      }
      resetUserForm();
    };

    const handleUserDelete = (user) => {
      if (user.role === 'admin') {
        alert('管理者は削除できません');
        return;
      }
      if (confirm(`${user.name} さんを削除しますか？`)) {
        handleDeleteUser(user.id);
      }
    };

    return (
      <div className="min-h-screen bg-slate-800 text-slate-100 p-6">
        <div className="max-w-6xl mx-auto">
          <header className="flex justify-between items-center mb-8 pb-4 border-b border-slate-600">
            <h1 className="text-3xl font-bold flex items-center gap-3">
              <Icon type="users" size={32} /> 管理者コンソール
            </h1>
            <div className="flex gap-3">
              <button onClick={clearData} className="bg-red-900/50 hover:bg-red-900 text-red-200 px-4 py-2 rounded border border-red-800">データ初期化</button>
              <button onClick={() => setViewMode('login')} className="bg-slate-700 hover:bg-slate-600 px-6 py-2 rounded text-lg">トップ画面に戻る</button>
            </div>
          </header>

          {/* ユニット名設定 */}
          <div className="bg-slate-700 p-4 rounded-lg mb-8 flex items-center gap-4 border border-slate-600">
            <label className="font-bold text-slate-300 whitespace-nowrap">ユニット名設定:</label>
            <input type="text" value={editUnitName} onChange={(e) => setEditUnitName(e.target.value)} 
              className="bg-slate-800 border border-slate-500 rounded px-3 py-2 text-white flex-1" />
            <button onClick={handleUnitNameChange} className="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded font-bold">変更</button>
          </div>

          <div className="flex gap-4 mb-6 overflow-x-auto pb-2">
            <button onClick={() => { resetForm(); setTab('status'); }}
              className={"px-6 py-4 rounded-lg font-bold text-lg whitespace-nowrap " + (tab === 'status' ? 'bg-blue-500 text-white' : 'bg-slate-700 text-slate-300')}>
              既読状況・編集
            </button>
            <button onClick={() => { resetForm(); setTab('create'); }}
              className={"px-6 py-4 rounded-lg font-bold text-lg whitespace-nowrap " + (tab === 'create' ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-300')}>
              新規連絡作成
            </button>
            <button onClick={() => { resetForm(); setTab('users'); }}
              className={"px-6 py-4 rounded-lg font-bold text-lg whitespace-nowrap " + (tab === 'users' ? 'bg-purple-600 text-white' : 'bg-slate-700 text-slate-300')}>
              職員管理
            </button>
          </div>

          {tab === 'status' && (
            <div className="space-y-6">
              {messages.map(msg => {
                const status = getMessageReadStatus(msg.id);
                const isHigh = msg.priority === 'high';
                return (
                  <div key={msg.id} className="bg-slate-700 rounded-xl p-6 border border-slate-600">
                    <div className="flex justify-between items-start mb-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <span className="text-slate-400 text-sm">{new Date(msg.timestamp).toLocaleString()}</span>
                        </div>
                        <h3 className={"font-bold text-2xl " + (isHigh ? 'text-red-300' : 'text-white')}>
                          {isHigh && '【重要】'} {msg.title}
                        </h3>
                      </div>
                      <div className="flex gap-2 ml-4">
                        <button onClick={() => startEdit(msg)} className="bg-blue-600 hover:bg-blue-500 p-2 rounded text-white" title="編集">
                          <Icon type="edit" />
                        </button>
                        <button onClick={() => handleDelete(msg.id)} className="bg-red-600 hover:bg-red-500 p-2 rounded text-white" title="削除">
                          <Icon type="trash" />
                        </button>
                      </div>
                    </div>
                    <div className="bg-slate-800 p-4 rounded-lg">
                      <div className="flex justify-between items-center mb-2">
                        <span className="text-green-400 font-bold">既読: {status.readCount}人</span>
                        <span className="text-red-400 font-bold">未読: {status.unreadUsers.length}人</span>
                      </div>
                      {status.unreadUsers.length > 0 ? (
                        <div className="flex flex-wrap gap-2">
                          {status.unreadUsers.map(u => (
                            <span key={u.id} className="bg-red-900/40 text-red-200 px-3 py-1 rounded text-sm border border-red-900/50">{u.name}</span>
                          ))}
                        </div>
                      ) : (
                        <span className="text-slate-500">全員確認済み</span>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {tab === 'create' && (
            <div className="bg-slate-700 p-8 rounded-xl">
              <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
                {editingId ? <><Icon type="edit" /> 連絡事項を編集</> : <><Icon type="layout" /> 新しい連絡を作成</>}
              </h2>
              <div className="space-y-6">
                <div>
                  <label className="block text-slate-400 mb-2 font-bold">タイトル</label>
                  <input type="text" value={title} onChange={(e) => setTitle(e.target.value)}
                    className="w-full p-4 rounded-lg bg-slate-800 border border-slate-600 focus:border-blue-500 outline-none text-white text-lg"
                    placeholder="例：インフルエンザワクチン接種について" />
                </div>
                <div>
                  <label className="block text-slate-400 mb-2 font-bold">重要度</label>
                  <div className="flex gap-4 bg-slate-800 p-3 rounded-lg border border-slate-600">
                    <label className="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-700 rounded flex-1">
                      <input type="radio" name="priority" value="normal" checked={priority === 'normal'} onChange={() => setPriority('normal')} className="w-5 h-5" /> 通常
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer text-red-300 p-2 hover:bg-slate-700 rounded flex-1">
                      <input type="radio" name="priority" value="high" checked={priority === 'high'} onChange={() => setPriority('high')} className="w-5 h-5" /> 重要
                    </label>
                  </div>
                </div>
                <div>
                  <label className="block text-slate-400 mb-2 font-bold">内容</label>
                  <textarea value={content} onChange={(e) => setContent(e.target.value)}
                    className="w-full p-4 h-48 rounded-lg bg-slate-800 border border-slate-600 focus:border-blue-500 outline-none text-white text-lg leading-relaxed"
                    placeholder="詳細を入力してください..." />
                </div>
                <div className="flex gap-4 pt-4">
                  {editingId && (
                    <button onClick={() => { resetForm(); setTab('status'); }} className="bg-slate-600 hover:bg-slate-500 text-white font-bold py-4 px-8 rounded-xl flex-1 text-xl">キャンセル</button>
                  )}
                  <button onClick={handleSubmit} className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-xl flex-[2] text-xl shadow-lg">
                    {editingId ? '更新する' : '投稿する'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {tab === 'users' && (
            <div className="space-y-8">
              {/* 職員追加・編集フォーム */}
              <div className="bg-slate-700 p-6 rounded-xl border border-slate-600">
                <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                  {editingUser ? <><Icon type="edit" /> 職員情報を編集</> : <><Icon type="plus" /> 職員を追加</>}
                </h2>
                <form onSubmit={handleUserSubmit} className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                  <div className="md:col-span-3">
                    <label className="block text-slate-400 text-sm mb-1">名前 <span className="text-red-400">*</span></label>
                    <input type="text" value={userName} onChange={(e) => setUserName(e.target.value)}
                      className="w-full p-3 rounded bg-slate-800 border border-slate-600 focus:border-blue-500 outline-none text-white"
                      placeholder="例：山田 花子" required />
                  </div>
                  <div className="md:col-span-1 flex gap-2">
                    {editingUser && (
                      <button type="button" onClick={resetUserForm} className="bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-4 rounded flex-1">
                        <Icon type="x" />
                      </button>
                    )}
                    <button type="submit" className="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-4 rounded flex-[2] shadow-lg">
                      {editingUser ? '更新' : '追加'}
                    </button>
                  </div>
                </form>
              </div>

              {/* 職員一覧 */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {users.map(user => (
                  <div key={user.id} className="bg-slate-700 p-4 rounded-lg border border-slate-600 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 bg-blue-900/50 rounded-full flex items-center justify-center text-xl font-bold text-blue-200 border border-blue-800">
                        {user.image}
                      </div>
                      <div>
                        <p className="font-bold text-lg"><AdminBadge user={user} /></p>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => startEditUser(user)} className="bg-blue-600 hover:bg-blue-500 p-2 rounded text-white" title="編集">
                        <Icon type="edit" size={18} />
                      </button>
                      {user.role !== 'admin' && (
                        <button onClick={() => handleUserDelete(user)} className="bg-red-600 hover:bg-red-500 p-2 rounded text-white" title="削除">
                          <Icon type="trash" size={18} />
                        </button>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  return (
    <div>
      {viewMode === 'login' && <LoginScreen />}
      {viewMode === 'dashboard' && currentUser && <DashboardScreen />}
      {viewMode === 'admin' && <AdminScreen />}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</htm